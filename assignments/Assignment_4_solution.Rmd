---
title: "Assignment 4"
author: "Julia Haaf & Nicole Cruz"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    highlight: pygments
urlcolor: teal
header-includes:
   - \usepackage{graphicx} 
   - \usepackage[font=small,labelfont=bf]{caption}
   - \usepackage{float} 
   - \usepackage{xcolor}
   - \definecolor{steelblue}{RGB}{70,130,180}
   - \usepackage{amssymb}
---

```{r setup, include=FALSE, error = F, warning = F, message = F}
knitr::opts_chunk$set(echo = T, warning = F, error = F, message = F)
```

### Packages

```{r packages}
library(tidyverse)   # Graphs with ggplot()
library(knitr)       # Tables with kable() 
library(ggokabeito)  # colorblind friendly colors
library(viridis)     # colorblind friendly colors
library(brms)        # Hierarchical Bayesian models
library(rstan)       # Interface to Stan
library(shinystan)   # Model output graphs
library(bayesplot)   # Model output graphs

# General settings
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
options(contrasts = c("contr.equalprior_pairs", "contr.poly"))
set.seed(1234) # For reproducibility
```

### Preparation

Data: `penguins`
```{r penguins}
library(palmerpenguins)
# data(package = 'palmerpenguins')
head(penguins)
```

The data consist of several measurements of penguins of the Palmer archipel in Antarctica. 

| Variable | Description |
|----------|----------------------------------------------|
|`species` | Factor: Adelie, Chinstrap, Gentoo            |
| `island` | Factor: Biscoe, Dream, Torgensen             |
| `bill_len` | Numeric: Mean = 43.91, range [32.10, 59.6] |
| `bill_dep` | Numeric: Mean = 17.15, range [13.10, 21.5] |
| `flipper_len`| Numeric: Mean = 200.9, range [172, 231]  |
| `body_mass` | Numeric: Mean = 4202, range [2700, 6300]  |
| `sex` | Factor: female, male |
| `year` | Numeric: 2007, 2008, 2009 |

```{r graph, fig.width=3.4, fig.height = 2.8, fig.align = "center"}
penguins <- penguins
g1 <- ggplot(penguins, aes(x = bill_length_mm, y = flipper_length_mm, color = species))+
  geom_point(alpha = .5)+
  scale_color_viridis_d(begin = .1, end = .9)+
  labs(x = "Bill length", y = "Flipper length", color = "Species")+
  theme_bw()
g1

penguins <- na.omit(penguins)
penguins$bill_length_mm <- penguins$bill_length_mm - mean(penguins$bill_length_mm)
penguins$bill_depth_mm <- penguins$bill_depth_mm - mean(penguins$bill_depth_mm)

```

## Excercise 1

Analyse the penguins dataset to investigate the hypothesis that flipper length is influenced by bill length and / or bill depth. Do so following a series of steps in the Bayesian workflow: 

1. Translate the hypothesis into a Bayesian mathematical model. What is the general structure of this model? 

$Y_i$ is the flipper length of the $i$th penguin. $X_{i, 1}$ is the bill length of the $i$th penguin and $X_{i, 2}$ is the bill depth of the $i$th penguin. Then

\[Y_i \sim \mbox{Normal}(\mu_i, \sigma^2,)\]

$\mu_i = \beta_0 + X_{i, 1} \beta_1 + X_{i, 2} \beta_2$

We need priors on all $\betas$ and $\sigma$.

2. Define prior distributions for the model. 

If you want the intercept to be only positive values
```{r}
default_prior(
  flipper_length_mm ~ 1 + bill_length_mm + bill_depth_mm + (1 + bill_depth_mm| species)
  , data = penguins
)

penguinprior <- c(brms::prior(gamma(200, 1), class = "Intercept")
                  , brms::prior(normal(0, 10), class = "b")
                  , brms::prior(student_t(3, 0, 25), class = "sigma"))
```

Prior prediction with lowe bound

```{r runpriorpredwlb, cache = T}
priorsampling <- brm(
  flipper_length_mm ~ 1 + bill_length_mm + bill_depth_mm
  , data = penguins
  , prior = penguinprior
  , sample_prior = "only"
  , iter = 1000
)

plot(priorsampling)
prior_samples <- posterior_predict(priorsampling)
```

If you don't care
```{r}
default_prior(
  flipper_length_mm ~ 1 + bill_length_mm + bill_depth_mm
  , data = penguins
)

penguinprior <- c(brms::prior(normal(0, 10), class = "b")
                  , brms::prior(normal(200, 25), class = "Intercept")
                  , brms::prior(student_t(3, 0, 25), class = "sigma"))
```


3. Conduct prior predictive checks.

```{r}
penguins_sim <- data.frame(
  flipper_length_mm = rep(200, 333)
  , bill_length_mm = rnorm(333, 45, 5)
  , bill_depth_mm = rnorm(333, 17, 2.5)
)
```


```{r runpriorpred, cache = T}
priorsampling <- brm(
  flipper_length_mm ~ 1 + bill_length_mm + bill_depth_mm
  , data = penguins
  , prior = penguinprior
  , sample_prior = "only"
  , iter = 1000
)

plot(priorsampling)
prior_samples <- posterior_predict(priorsampling)
```

```{r}
bayesplot::ppc_dens_overlay(penguins$flipper_length_mm, prior_samples[1:500,]) + 
  theme_light(base_size = 16)
```


4. Apply the model to the data with `brm()`. What convergence parameters would you to look at? Briefly interpet the output. 

```{r samplepost, cache = T}
fit <- brm(
  flipper_length_mm ~ 1 + bill_length_mm + bill_depth_mm
  , data = penguins
  , prior = penguinprior
  , iter = 1000
)
fit
```

5. Plot the posterior densities for the parameters and compute their credible intervals. 

```{r}
plot(fit)

mcmc_areas(fit, prob = 0.8, pars = c("b_Intercept", "b_bill_length_mm", "b_bill_depth_mm", "sigma")) +
  labs(title = "Posterior distributions"
       , subtitle = "with medians and 80% intervals") +
  theme_light(base_size = 20)

mcmc_areas(fit, prob = 0.8, pars = c("b_bill_length_mm", "b_bill_depth_mm")) +
  labs(title = "Posterior distributions"
       , subtitle = "with medians and 80% intervals") +
  theme_light(base_size = 20)
```


6. Define two alternative models and compare them to your initial model via Bayes factors. Briefly interpret the results. 

7. Conduct posterior predictive checks. 

8. Consider the evidence for your model as a whole after applying it to the data. What implications do the outcomes have for the hypothesis, if any? What can we learn from the analysis results? 

